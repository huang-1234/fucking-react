# md æ¸²æŸ“


åŸºäºä½ çš„éœ€æ±‚ï¼Œæˆ‘å°†ä¸ºä½ è®¾è®¡ä¸€ä¸ªåŸºäº `react-markdown` å’Œ TypeScript çš„ Markdown æ¸²æŸ“ç»„ä»¶æŠ€æœ¯æ–¹æ¡ˆã€‚è¿™ä¸ªæ–¹æ¡ˆç»¼åˆäº†å®‰å…¨æ€§ã€å¯æ‰©å±•æ€§ã€æ€§èƒ½ä¼˜åŒ–å’Œå¼€å‘è€…ä½“éªŒï¼Œç‰¹åˆ«é€‚åˆåœ¨ React + TypeScript é¡¹ç›®ä¸­å®ç°æŠ€æœ¯æ–‡æ¡£æ¸²æŸ“ã€‚

### ç›®æ ‡

#### 1. åŠŸèƒ½ç›®æ ‡
- æ”¯æŒ Markdown è¯­æ³•
- æ”¯æŒä»£ç é«˜äº®
- æ”¯æŒè¡¨æ ¼
- æ”¯æŒä»»åŠ¡åˆ—è¡¨
- æ”¯æŒæ•°å­¦å…¬å¼
- æ”¯æŒç›®å½•
- æ”¯æŒé”šç‚¹å¯¼èˆª
- æ”¯æŒä¸»é¢˜åˆ‡æ¢
- æ”¯æŒç¼“å­˜
- æ”¯æŒè™šæ‹Ÿæ»šåŠ¨

#### 2. æ€§èƒ½ç›®æ ‡

- æ”¯æŒè™šæ‹Ÿæ»šåŠ¨
- æ”¯æŒç¼“å­˜
- æ”¯æŒä¸»é¢˜åˆ‡æ¢
- æ”¯æŒç¼“å­˜
- æ”¯æŒè™šæ‹Ÿæ»šåŠ¨

#### 3. å®‰å…¨æ€§ç›®æ ‡

- æ”¯æŒ XSS é˜²æŠ¤
- æ”¯æŒå¤–éƒ¨é“¾æ¥å¤„ç†
- æ”¯æŒæ•°å­¦å…¬å¼
- æ”¯æŒç›®å½•
- æ”¯æŒé”šç‚¹å¯¼èˆª

#### 4. å¯ç»´æŠ¤æ€§ç›®æ ‡

- æ”¯æŒ TypeScript æ¥å£å®šä¹‰
- æ”¯æŒä»£ç é«˜äº®
- æ”¯æŒè¡¨æ ¼
- æ”¯æŒä»»åŠ¡åˆ—è¡¨

#### 5. ç”¨æˆ·ä½“éªŒç›®æ ‡

- æ”¯æŒä¸»é¢˜åˆ‡æ¢
- æ”¯æŒç¼“å­˜
- æ”¯æŒè™šæ‹Ÿæ»šåŠ¨

#### 6. å¼€å‘ä½“éªŒç›®æ ‡

- æ”¯æŒ TypeScript æ¥å£å®šä¹‰
- æ”¯æŒä»£ç é«˜äº®
- æ”¯æŒè¡¨æ ¼
- æ”¯æŒä»»åŠ¡åˆ—è¡¨

#### 7. æ‰©å±•æ€§ç›®æ ‡

- æ”¯æŒæ•°å­¦å…¬å¼
- æ”¯æŒç›®å½•
- æ”¯æŒé”šç‚¹å¯¼èˆª
- æ”¯æŒæ•°å­¦å…¬å¼
- æ”¯æŒç›®å½•
- æ”¯æŒé”šç‚¹å¯¼èˆª


#### 8. éƒ¨ç½²ä¸æ„å»ºç›®æ ‡

- æ”¯æŒ Tree Shaking é…ç½®
- æ”¯æŒæŒ‰éœ€åŠ è½½ç­–ç•¥
- æ”¯æŒä»£ç åˆ†å‰²
- æ”¯æŒä»£ç å‹ç¼©
- æ”¯æŒä»£ç æ··æ·†
- æ”¯æŒä»£ç ç¾åŒ–


#### mdæ¸²æŸ“æ§åˆ¶é¢æ¿

- åœ¨å·¦ä¾§æ·»åŠ ä¸€ä¸ªmdæ¸²æŸ“æ§åˆ¶é¢æ¿ï¼Œç”¨äºç²¾ç»†åŒ–æ§åˆ¶mdæ¸²æŸ“çš„é…ç½®
- åœ¨ä¸Šæ–¹æ·»åŠ ä¸€ä¸ªmdæ¸²æŸ“æ€»ä½“è®¾ç½®ï¼Œç”¨äºè®¾ç½®mdæ¸²æŸ“çš„æ€»ä½“é…ç½®
- åœ¨ä¸‹æ–¹æ·»åŠ ä¸€ä¸ªmdæ¸²æŸ“å†…å®¹åŒºåŸŸï¼Œç”¨äºæ˜¾ç¤ºmdæ¸²æŸ“çš„å†…å®¹

#### æ€»ä½“è®¾ç½®

- æ”¯æŒä¸»é¢˜åˆ‡æ¢
- æ”¯æŒç¼“å­˜
- æ”¯æŒè™šæ‹Ÿæ»šåŠ¨



### ğŸ“¦ ä¸€ã€æ ¸å¿ƒä¾èµ–ä¸æ¶æ„è®¾è®¡

#### 1. **ä¾èµ–é€‰æ‹©**
ä»¥ä¸‹æ˜¯å®ç°åŠŸèƒ½å®Œå¤‡çš„ Markdown æ¸²æŸ“å™¨æ‰€éœ€çš„æ ¸å¿ƒä¾èµ–ï¼š

| **ä¾èµ–åŒ…** | **ä½œç”¨** | **ç±»å‹** |
| :--- | :--- | :--- |
| `react-markdown` | æ ¸å¿ƒè½¬æ¢å¼•æ“ï¼Œå°† Markdown è½¬ä¸º React å…ƒç´  | ç”Ÿäº§ä¾èµ– |
| `remark-gfm` | æ”¯æŒ GitHub é£æ ¼ Markdown æ‰©å±•ï¼ˆè¡¨æ ¼ã€ä»»åŠ¡åˆ—è¡¨ç­‰ï¼‰ | ç”Ÿäº§ä¾èµ– |
| `rehype-sanitize` | æ¸…ç† HTML å†…å®¹ï¼Œé˜²æ­¢ XSS æ”»å‡» | ç”Ÿäº§ä¾èµ– |
| `rehype-external-links` | è‡ªåŠ¨å¤„ç†å¤–éƒ¨é“¾æ¥ï¼ˆæ·»åŠ  target="_blank" ç­‰ï¼‰ | ç”Ÿäº§ä¾èµ– |
| `react-syntax-highlighter` | ä»£ç è¯­æ³•é«˜äº® | ç”Ÿäº§ä¾èµ– |
| `lucide-react` | å›¾æ ‡åº“ï¼ˆç”¨äºå¤åˆ¶æŒ‰é’®ç­‰ï¼‰ | ç”Ÿäº§ä¾èµ– |
| `@types/react-syntax-highlighter` | æä¾›ç±»å‹å®šä¹‰ | å¼€å‘ä¾èµ– |

å®‰è£…å‘½ä»¤ï¼š
```bash
npm install react-markdown remark-gfm rehype-sanitize rehype-external-links react-syntax-highlighter lucide-react
npm install -D @types/react-syntax-highlighter
```

#### 2. **TypeScript æ¥å£å®šä¹‰**
```typescript
// types/markdown.ts
import type { Components } from 'react-markdown';

export interface MarkdownRendererProps {
  content: string;
  className?: string;
  allowHtml?: boolean;
  linkTarget?: '_blank' | '_self' | '_parent' | '_top';
  allowedElements?: string[];
  skipHtml?: boolean;
}

export interface CodeBlockProps {
  node?: any;
  inline?: boolean;
  className?: string;
  children?: React.ReactNode;
  [key: string]: any;
}

export interface CustomComponents extends Partial<Components> {
  code?: React.ComponentType<CodeBlockProps>;
}
```

### ğŸ›¡ï¸ äºŒã€å®‰å…¨é…ç½®

#### 1. **XSS é˜²æŠ¤ç­–ç•¥**
```typescript
// utils/sanitizeSchema.ts
export const sanitizeSchema = {
  tagNames: ['h1', 'h2', 'h3', 'h4', 'h5', 'h6', 'p', 'em', 'strong', 'code',
             'pre', 'blockquote', 'ul', 'ol', 'li', 'a', 'img', 'table', 'thead',
             'tbody', 'tr', 'th', 'td'],
  attributes: {
    a: ['href', 'title', 'target', 'rel'],
    img: ['src', 'alt', 'title', 'width', 'height'],
    '*': ['className', 'id']
  },
  protocols: {
    href: ['http', 'https', 'mailto'],
    src: ['http', 'https', 'data']
  }
};
```

#### 2. **å®‰å…¨æ¸²æŸ“é…ç½®**
```typescript
// config/markdownConfig.ts
import { sanitizeSchema } from '@/utils/sanitizeSchema';

export const markdownConfig = {
  skipHtml: false,
  allowedElements: sanitizeSchema.tagNames,
  linkTarget: '_blank' as const,
  transformLinkUri: (uri: string) => {
    // éªŒè¯ URL å®‰å…¨æ€§
    const allowedProtocols = ['http:', 'https:', 'mailto:'];
    try {
      const url = new URL(uri, window.location.origin);
      return allowedProtocols.includes(url.protocol) ? uri : '';
    } catch {
      return '';
    }
  }
};
```

### ğŸ’» ä¸‰ã€æ ¸å¿ƒç»„ä»¶å®ç°

#### 1. **ä»£ç é«˜äº®ç»„ä»¶**
```typescript
// components/CodeBlock.tsx
import React, { useState } from 'react';
import { Prism as SyntaxHighlighter } from 'react-syntax-highlighter';
import { oneDark, oneLight } from 'react-syntax-highlighter/dist/esm/styles/prism';
import { Copy, Check } from 'lucide-react';
import type { CodeBlockProps } from '@/types/markdown';

// æŒ‰éœ€å¯¼å…¥è¯­è¨€æ”¯æŒ
import javascript from 'react-syntax-highlighter/dist/esm/languages/prism/javascript';
import typescript from 'react-syntax-highlighter/dist/esm/languages/prism/typescript';
import css from 'react-syntax-highlighter/dist/esm/languages/prism/css';
import html from 'react-syntax-highlighter/dist/esm/languages/prism/markup';

SyntaxHighlighter.registerLanguage('javascript', javascript);
SyntaxHighlighter.registerLanguage('typescript', typescript);
SyntaxHighlighter.registerLanguage('css', css);
SyntaxHighlighter.registerLanguage('html', html);

const CodeBlock: React.FC<CodeBlockProps> = ({
  inline,
  className,
  children,
  ...props
}) => {
  const [copied, setCopied] = useState(false);
  const match = /language-(\w+)/.exec(className || '');
  const language = match ? match[1] : '';
  const codeString = String(children).replace(/\n$/, '');

  const handleCopy = async () => {
    try {
      await navigator.clipboard.writeText(codeString);
      setCopied(true);
      setTimeout(() => setCopied(false), 2000);
    } catch (err) {
      console.error('å¤åˆ¶å¤±è´¥:', err);
    }
  };

  if (inline) {
    return (
      <code className={className} {...props}>
        {children}
      </code>
    );
  }

  return (
    <div className="code-block relative group">
      <div className="flex justify-between items-center px-4 py-2 bg-gray-100 dark:bg-gray-800 rounded-t-lg">
        <span className="text-sm text-gray-600 dark:text-gray-400">
          {language}
        </span>
        <button
          onClick={handleCopy}
          className="p-2 rounded hover:bg-gray-200 dark:hover:bg-gray-700 transition-colors"
          aria-label="å¤åˆ¶ä»£ç "
        >
          {copied ? (
            <Check size={16} className="text-green-500" />
          ) : (
            <Copy size={16} className="text-gray-500" />
          )}
        </button>
      </div>
      <SyntaxHighlighter
        style={oneDark}
        language={language}
        PreTag="div"
        showLineNumbers
        customStyle={{
          margin: 0,
          borderTopLeftRadius: 0,
          borderTopRightRadius: 0
        }}
        {...props}
      >
        {codeString}
      </SyntaxHighlighter>
    </div>
  );
};

export default CodeBlock;
```

#### 2. **ä¸»æ¸²æŸ“ç»„ä»¶**
```tsx
// components/MarkdownRenderer.tsx
import React from 'react';
import ReactMarkdown from 'react-markdown';
import remarkGfm from 'remark-gfm';
import rehypeSanitize from 'rehype-sanitize';
import rehypeExternalLinks from 'rehype-external-links';
import { Prism as SyntaxHighlighter } from 'react-syntax-highlighter';
import { oneDark } from 'react-syntax-highlighter/dist/esm/styles/prism';
import CodeBlock from './CodeBlock';
import type { MarkdownRendererProps, CustomComponents } from '@/types/markdown';
import { sanitizeSchema } from '@/utils/sanitizeSchema';
import { markdownConfig } from '@/config/markdownConfig';

const MarkdownRenderer: React.FC<MarkdownRendererProps> = ({
  content,
  className = '',
  allowHtml = false,
  linkTarget = '_blank',
  allowedElements = sanitizeSchema.tagNames,
  skipHtml = false,
  ...props
}) => {
  // è‡ªå®šä¹‰ç»„ä»¶é…ç½®
  const components: CustomComponents = {
    h1: ({ children }) => (
      <h1 className="text-3xl font-bold mb-6 mt-8 border-b pb-2 dark:border-gray-700">
        {children}
      </h1>
    ),
    h2: ({ children }) => (
      <h2 className="text-2xl font-semibold mb-4 mt-6 border-b pb-1 dark:border-gray-700">
        {children}
      </h2>
    ),
    h3: ({ children }) => (
      <h3 className="text-xl font-medium mb-3 mt-5">{children}</h3>
    ),
    p: ({ children }) => (
      <p className="mb-4 leading-7 text-gray-800 dark:text-gray-200">
        {children}
      </p>
    ),
    a: ({ href, children }) => (
      <a
        href={href}
        target={linkTarget}
        rel="noopener noreferrer"
        className="text-blue-600 hover:text-blue-800 dark:text-blue-400 dark:hover:text-blue-300 underline"
      >
        {children}
      </a>
    ),
    code: CodeBlock,
    table: ({ children }) => (
      <div className="overflow-x-auto my-6">
        <table className="min-w-full divide-y divide-gray-200 dark:divide-gray-700">
          {children}
        </table>
      </div>
    ),
    th: ({ children }) => (
      <th className="px-4 py-3 bg-gray-100 dark:bg-gray-800 text-left text-xs font-medium text-gray-700 dark:text-gray-300 uppercase tracking-wider">
        {children}
      </th>
    ),
    td: ({ children }) => (
      <td className="px-4 py-2 border-t border-gray-200 dark:border-gray-700">
        {children}
      </td>
    ),
    blockquote: ({ children }) => (
      <blockquote className="border-l-4 border-blue-500 italic my-4 pl-4 text-gray-600 dark:text-gray-400">
        {children}
      </blockquote>
    )
  };

  return (
    <div className={`markdown-container ${className}`}>
      <ReactMarkdown
        remarkPlugins={[remarkGfm]}
        rehypePlugins={[
          [rehypeSanitize, sanitizeSchema],
          [rehypeExternalLinks, { target: linkTarget, rel: ['nofollow'] }]
        ]}
        components={components}
        skipHtml={skipHtml}
        allowedElements={allowedElements}
        transformLinkUri={markdownConfig.transformLinkUri}
        {...props}
      >
        {content}
      </ReactMarkdown>
    </div>
  );
};

export default MarkdownRenderer;
```

### ğŸ¨ å››ã€æ ·å¼ä¸ä¸»é¢˜ç³»ç»Ÿ

#### 1. **åŸºç¡€æ ·å¼é…ç½®**
```css
/* styles/markdown.css */
.markdown-container {
  line-height: 1.7;
  color: theme('colors.gray.800');
}

.markdown-container.dark {
  color: theme('colors.gray.200');
}

/* ä»£ç å—æ ·å¼ */
.markdown-container pre {
  border-radius: 0.5rem;
  margin: 1.5rem 0;
}

.markdown-container code {
  font-family: 'Fira Code', 'Monaco', 'Consolas', monospace;
  font-size: 0.9em;
}

/* è¡¨æ ¼æ ·å¼ */
.markdown-container table {
  width: 100%;
  border-collapse: collapse;
}

.markdown-container th {
  font-weight: 600;
  text-transform: uppercase;
  letter-spacing: 0.05em;
}
```

#### 2. **ä¸»é¢˜åˆ‡æ¢æ”¯æŒ**
```tsx
// hooks/useTheme.ts
import { useState, useEffect } from 'react';

export const useTheme = () => {
  const [theme, setTheme] = useState<'light' | 'dark'>('light');

  useEffect(() => {
    const mediaQuery = window.matchMedia('(prefers-color-scheme: dark)');
    const handleChange = (e: MediaQueryListEvent) => {
      setTheme(e.matches ? 'dark' : 'light');
    };

    setTheme(mediaQuery.matches ? 'dark' : 'light');
    mediaQuery.addEventListener('change', handleChange);

    return () => mediaQuery.removeEventListener('change', handleChange);
  }, []);

  return theme;
};

// åœ¨ç»„ä»¶ä¸­ä½¿ç”¨
const theme = useTheme();
const isDarkMode = theme === 'dark';
```

### âš¡ äº”ã€æ€§èƒ½ä¼˜åŒ–ç­–ç•¥

#### 1. **ç¼“å­˜ä¸è®°å¿†åŒ–**
```tsx
// utils/cache.ts
interface CacheItem {
  content: string;
  timestamp: number;
  html: string;
}

const CACHE_DURATION = 5 * 60 * 1000; // 5åˆ†é’Ÿç¼“å­˜
const cache = new Map<string, CacheItem>();

export const getCachedMarkdown = (content: string): string | null => {
  const cached = cache.get(content);
  if (cached && Date.now() - cached.timestamp < CACHE_DURATION) {
    return cached.html;
  }
  return null;
};

export const cacheMarkdown = (content: string, html: string): void => {
  cache.set(content, {
    content,
    timestamp: Date.now(),
    html
  });
};

// ä¼˜åŒ–åçš„ç»„ä»¶
const MemoizedMarkdownRenderer = React.memo(MarkdownRenderer);
```

#### 2. **è™šæ‹Ÿæ»šåŠ¨æ”¯æŒ**
```tsx
// components/VirtualizedMarkdown.tsx
import { FixedSizeList as List } from 'react-window';

const VirtualizedMarkdown: React.FC<{ content: string }> = ({ content }) => {
  const lines = content.split('\n');

  const Row = ({ index, style }: { index: number; style: React.CSSProperties }) => (
    <div style={style}>
      <MarkdownRenderer content={lines[index]} />
    </div>
  );

  return (
    <List
      height={600}
      itemCount={lines.length}
      itemSize={100}
      width="100%"
    >
      {Row}
    </List>
  );
};
```

### ğŸ”§ å…­ã€æ‰©å±•åŠŸèƒ½å®ç°

#### 1. **æ•°å­¦å…¬å¼æ”¯æŒ**
```bash
// å®‰è£…é¢å¤–ä¾èµ–
npm install rehype-katex katex

// é…ç½®æ•°å­¦å…¬å¼
import rehypeKatex from 'rehype-katex';
import 'katex/dist/katex.min.css';

// åœ¨ç»„ä»¶ä¸­æ·»åŠ 
rehypePlugins={[
  // ...å…¶ä»–æ’ä»¶
  rehypeKatex
]}
```

#### 2. **ç›®å½•ç”Ÿæˆä¸é”šç‚¹å¯¼èˆª**
```tsx
// hooks/useHeadings.ts
import { useState, useEffect } from 'react';

export interface Heading {
  id: string;
  text: string;
  level: number;
}

export const useHeadings = (content: string): Heading[] => {
  const [headings, setHeadings] = useState<Heading[]>([]);

  useEffect(() => {
    const regex = /^(#{1,6})\s+(.+)$/gm;
    const matches = Array.from(content.matchAll(regex));
    const headingList: Heading[] = matches.map((match, index) => ({
      id: `heading-${index}`,
      text: match[2],
      level: match[1].length
    }));
    setHeadings(headingList);
  }, [content]);

  return headings;
};

// ç›®å½•ç»„ä»¶
const TableOfContents: React.FC<{ headings: Heading[] }> = ({ headings }) => (
  <nav className="toc">
    <h3>ç›®å½•</h3>
    <ul>
      {headings.map(heading => (
        <li key={heading.id} style={{ marginLeft: `${(heading.level - 1) * 1}rem` }}>
          <a href={`#${heading.id}`}>{heading.text}</a>
        </li>
      ))}
    </ul>
  </nav>
);
```

### ğŸ“ ä¸ƒã€ä½¿ç”¨ç¤ºä¾‹

```tsx
// pages/Documentation.tsx
import React, { useState } from 'react';
import MarkdownRenderer from '@/components/MarkdownRenderer';
import TableOfContents from '@/components/TableOfContents';
import { useHeadings } from '@/hooks/useHeadings';

const Documentation: React.FC = () => {
  const [content, setContent] = useState(`# é¡¹ç›®æ–‡æ¡£

## ä»‹ç»
è¿™æ˜¯ä¸€ä¸ªåŸºäº React å’Œ TypeScript çš„ Markdown æ¸²æŸ“ç»„ä»¶ã€‚

### åŠŸèƒ½ç‰¹æ€§
- âœ… ä»£ç é«˜äº®æ˜¾ç¤º
- âœ… è¡¨æ ¼æ”¯æŒ
- âœ… ä»»åŠ¡åˆ—è¡¨
- âœ… æ•°å­¦å…¬å¼

## å®‰è£…æŒ‡å—

\`\`\`bash
npm install react-markdown remark-gfm
\`\`\`

## ä½¿ç”¨ç¤ºä¾‹

\`\`\`typescript
import React from 'react';
import MarkdownRenderer from './MarkdownRenderer';

const App: React.FC = () => {
  return (
    <MarkdownRenderer content="# Hello World" />
  );
};
\`\`\`
`);

  const headings = useHeadings(content);

  return (
    <div className="documentation-container">
      <aside className="sidebar">
        <TableOfContents headings={headings} />
      </aside>
      <main className="content">
        <MarkdownRenderer content={content} />
      </main>
    </div>
  );
};

export default Documentation;
```

### ğŸš€ å…«ã€éƒ¨ç½²ä¸æ„å»ºä¼˜åŒ–

#### 1. **Tree Shaking é…ç½®**
```tsx
// vite.config.ts (æˆ– webpack.config.js)
export default defineConfig({
  build: {
    rollupOptions: {
      output: {
        manualChunks: {
          markdown: ['react-markdown', 'remark-gfm', 'rehype-sanitize'],
          syntax: ['react-syntax-highlighter', 'lucide-react']
        }
      }
    }
  }
});
```

#### 2. **æŒ‰éœ€åŠ è½½ç­–ç•¥**
```tsx
// åŠ¨æ€å¯¼å…¥è¯­æ³•é«˜äº®è¯­è¨€åŒ…
const loadLanguage = async (language: string) => {
  switch (language) {
    case 'javascript':
      return await import('react-syntax-highlighter/dist/esm/languages/prism/javascript');
    case 'typescript':
      return await import('react-syntax-highlighter/dist/esm/languages/prism/typescript');
    // å…¶ä»–è¯­è¨€...
  }
};
```

è¿™ä¸ªæŠ€æœ¯æ–¹æ¡ˆæä¾›äº†ä¸€ä¸ªåŠŸèƒ½å®Œå¤‡ã€å®‰å…¨å¯é ã€æ€§èƒ½ä¼˜å¼‚çš„ Markdown æ¸²æŸ“è§£å†³æ–¹æ¡ˆã€‚å®ƒç‰¹åˆ«é€‚åˆåœ¨ React + TypeScript é¡¹ç›®ä¸­ç”¨äºæŠ€æœ¯æ–‡æ¡£ã€åšå®¢ç³»ç»Ÿã€çŸ¥è¯†åº“ç­‰åœºæ™¯ã€‚æ–¹æ¡ˆè€ƒè™‘äº†å¼€å‘è€…ä½“éªŒã€ä»£ç å¯ç»´æŠ¤æ€§å’Œæœ€ç»ˆç”¨æˆ·ä½“éªŒï¼Œå¯ä»¥ç›´æ¥ç”¨äº Cursor çš„ç¼–ç ä»»åŠ¡ã€‚