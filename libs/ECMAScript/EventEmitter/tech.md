åœ¨ Node.js ä¸­å®ç° `æ·±æ‹·è´ï¼ˆDeep Cloneï¼‰`å’Œ `EventEmitter`è¿™ä¸¤ä¸ªæ ¸å¿ƒæ¨¡å—ï¼Œéœ€è¦ä½ å¯¹ JavaScript çš„å¯¹è±¡æœºåˆ¶å’Œäº‹ä»¶é©±åŠ¨æ¨¡å‹æœ‰æ¸…æ™°çš„ç†è§£ã€‚ä¸‹é¢æˆ‘å°†ä¸ºä½ è¯¦ç»†æ‹†è§£æ¯ä¸ªæ¨¡å—éœ€è¦å®ç°çš„éƒ¨åˆ†å’Œæ–¹æ³•ã€‚

# ğŸ“¦ ä¸€ã€æ·±æ‹·è´æ¨¡å— (Deep Clone)

åœ¨ JavaScript ä¸­ï¼Œæ·±æ‹·è´çš„ç›®çš„æ˜¯åˆ›å»ºä¸€ä¸ªå…¨æ–°çš„å¯¹è±¡ï¼Œæ–°å¯¹è±¡ä¸åŸå§‹å¯¹è±¡å®Œå…¨ç‹¬ç«‹ï¼Œå¯¹ä»»ä½•ä¸€å±‚æ•°æ®çš„ä¿®æ”¹éƒ½ä¸ä¼šå½±å“åŸå¯¹è±¡ã€‚

## 1. æ ¸å¿ƒåŸºç¡€åŠŸèƒ½

* **é€’å½’æ‹·è´**ï¼šè¿™æ˜¯æ·±æ‹·è´çš„æ ¸å¿ƒæ–¹æ³•ã€‚å‡½æ•°éœ€è¦èƒ½å¤Ÿéå†å¯¹è±¡çš„æ‰€æœ‰å±æ€§ï¼Œå¹¶å¯¹æ¯ä¸ªå±æ€§å€¼è¿›è¡Œé€’å½’æ‹·è´ï¼Œç›´åˆ°å¤„ç†å®Œæ‰€æœ‰åµŒå¥—å±‚çº§ã€‚
* **åŸºç¡€æ•°æ®ç±»å‹å¤„ç†**ï¼šå‡½æ•°åº”èƒ½æ­£ç¡®è¯†åˆ«å¹¶ç›´æ¥è¿”å›åŸºç¡€æ•°æ®ç±»å‹ï¼ˆå¦‚ `String`, `Number`, `Boolean`, `null`, `undefined`, `Symbol`ç­‰ï¼‰ï¼Œå› ä¸ºè¿™äº›å€¼æœ¬èº«å°±æ˜¯æŒ‰å€¼æ‹·è´çš„ã€‚
* **æ•°ç»„å’Œå¯¹è±¡åŒºåˆ†**ï¼šéœ€è¦å‡†ç¡®åˆ¤æ–­å½“å‰å€¼æ˜¯æ•°ç»„è¿˜æ˜¯æ™®é€šå¯¹è±¡ï¼Œä»¥ä¾¿åˆå§‹åŒ–æ­£ç¡®ç±»å‹çš„ç©ºå¯¹è±¡æˆ–ç©ºæ•°ç»„æ¥æ¥æ”¶æ‹·è´çš„å€¼ã€‚

## 2. ç‰¹æ®Šå¯¹è±¡ç±»å‹å¤„ç†

ä¸€ä¸ªå¥å£®çš„æ·±æ‹·è´å‡½æ•°å¿…é¡»è€ƒè™‘ JavaScript ä¸­ç‰¹æ®Šçš„å¯¹è±¡ç±»å‹ï¼š

* **Date å¯¹è±¡**ï¼šéœ€è¦åˆ›å»ºæ–°çš„ Date å®ä¾‹ï¼Œæ‹·è´å…¶æ—¶é—´å€¼ã€‚
* **RegExp å¯¹è±¡**ï¼šéœ€è¦åˆ›å»ºæ–°çš„ RegExp å®ä¾‹ï¼Œæ‹·è´å…¶æ¨¡å¼å’Œæ ‡å¿—ã€‚
* **Map å’Œ Set é›†åˆ**ï¼šéœ€è¦åˆ›å»ºæ–°çš„ Map æˆ– Setï¼Œå¹¶é€’å½’åœ°æ‹·è´å…¶ä¸­çš„æ¯ä¸€ä¸ªé”®å€¼å¯¹æˆ–æˆå‘˜ã€‚
* **Function (å¯é€‰)**ï¼šé€šå¸¸å‡½æ•°ä¸ä¼šè¢«æ·±æ‹·è´ï¼Œè€Œæ˜¯ç›´æ¥å¤ç”¨å¼•ç”¨ã€‚è¿™æ˜¯å› ä¸ºå‡½æ•°å®šä¹‰é€šå¸¸æ˜¯å…±äº«çš„ã€‚å¦‚æœéœ€è¦ç‰¹æ®Šå¤„ç†ï¼ˆå¦‚ç»‘å®šç‰¹å®šä¸Šä¸‹æ–‡ï¼‰ï¼Œåˆ™éœ€ä½¿ç”¨ `func.bind()`æˆ– `new Function(func.toString())`ç­‰æ–¹å¼ï¼Œä½†è¿™å¯èƒ½å¸¦æ¥æ€§èƒ½å’Œå®‰å…¨é—®é¢˜ï¼Œéœ€è°¨æ…è€ƒè™‘ã€‚

## 3. å¾ªç¯å¼•ç”¨å¤„ç†

å¾ªç¯å¼•ç”¨æ˜¯æ·±æ‹·è´ä¸­æœ€å¸¸è§ä¸”å¿…é¡»å¤„ç†çš„é™·é˜±ï¼Œå¦åˆ™ä¼šå¯¼è‡´é€’å½’è¿›å…¥æ­»å¾ªç¯ï¼Œæœ€ç»ˆæ ˆæº¢å‡ºã€‚

* **ä½¿ç”¨ WeakMap è®°å¿†å·²æ‹·è´å¯¹è±¡**ï¼šåœ¨é€’å½’è¿‡ç¨‹ä¸­ï¼Œä½¿ç”¨ä¸€ä¸ª `WeakMap`æ¥å­˜å‚¨**åŸå§‹å¯¹è±¡**å’Œ**å·²æ‹·è´çš„å¯¹è±¡**ä¹‹é—´çš„æ˜ å°„å…³ç³»ã€‚åœ¨æ‹·è´ä¸€ä¸ªå±æ€§å‰ï¼Œå…ˆæ£€æŸ¥æ­¤ `WeakMap`ä¸­æ˜¯å¦å·²å­˜åœ¨è¯¥åŸå§‹å¯¹è±¡çš„æ‹·è´ã€‚å¦‚æœå­˜åœ¨ï¼Œåˆ™ç›´æ¥è¿”å›ä¹‹å‰æ‹·è´å¥½çš„å¯¹è±¡ï¼Œä»è€Œæ‰“ç ´å¾ªç¯ã€‚

## 4. æ€§èƒ½ä¸æ‰©å±•è€ƒé‡

* **ä¸å¯å˜æ•°æ®ä¼˜åŒ–**ï¼šå¯¹äºä¸å¯å˜å¯¹è±¡ï¼ˆå¦‚ JavaScript ä¸­çš„åŸºæœ¬ç±»å‹åŒ…è£…å¯¹è±¡ï¼Œä½†åœ¨æ·±æ‹·è´è¯­å¢ƒä¸‹æ›´å¸¸æŒ‡åˆ¤æ–­æ˜¯å¦æ˜¯åŸç”Ÿå¯¹è±¡ï¼‰ï¼Œå¯ä»¥ç›´æ¥è¿”å›å…¶æœ¬èº«ï¼Œå› ä¸ºä¸å¯å˜æ•°æ®æ— æ³•è¢«ä¿®æ”¹ï¼Œå…±äº«å¼•ç”¨æ˜¯å®‰å…¨çš„ã€‚
* **æ‹·è´ç­–ç•¥å®šåˆ¶ (é«˜çº§)**ï¼šå¯ä»¥å‚è€ƒ Python çš„ `__deepcopy__`æ–¹æ³•æ€æƒ³ï¼Œä¸ºè‡ªå®šä¹‰ Class è®¾è®¡ä¸€ä¸ªæ¥å£ï¼ˆä¾‹å¦‚å®šä¹‰ä¸€ä¸ª `Symbol`å±æ€§ï¼‰ï¼Œè®©è¯¥ç±»å¯ä»¥è‡ªå·±æ§åˆ¶å¦‚ä½•è¢«æ·±æ‹·è´ï¼Œè¿™æä¾›äº†æå¤§çš„çµæ´»æ€§ã€‚

## 5. å®ç°ä»£ç ç¤ºä¾‹

ä»¥ä¸‹æ˜¯ä¸€ä¸ªè€ƒè™‘äº†ä¸Šè¿°è¦ç‚¹çš„æ·±æ‹·è´å‡½æ•°åŸºç¡€æ¡†æ¶ï¼š

```
function deepClone(source, memory = new WeakMap()) {
  // å¤„ç†åŸºç¡€æ•°æ®ç±»å‹å’Œå‡½æ•°
  if (source === null || typeof source !== 'object') {
    return source;
  }

  // å¤„ç†å¾ªç¯å¼•ç”¨
  if (memory.has(source)) {
    return memory.get(source);
  }

  // å¤„ç†Dateå¯¹è±¡
  if (source instanceof Date) {
    return new Date(source);
  }

  // å¤„ç†RegExpå¯¹è±¡
  if (source instanceof RegExp) {
    return new RegExp(source);
  }

  // å¤„ç†Mapé›†åˆ
  if (source instanceof Map) {
    const cloneMap = new Map();
    memory.set(source, cloneMap);
    source.forEach((value, key) => {
      cloneMap.set(deepClone(key, memory), deepClone(value, memory));
    });
    return cloneMap;
  }

  // å¤„ç†Seté›†åˆ
  if (source instanceof Set) {
    const cloneSet = new Set();
    memory.set(source, cloneSet);
    source.forEach(value => {
      cloneSet.add(deepClone(value, memory));
    });
    return cloneSet;
  }

  // å¤„ç†æ•°ç»„å’Œæ™®é€šå¯¹è±¡
  const cloneObj = Array.isArray(source) ? [] : {};
  memory.set(source, cloneObj);

  // ä½¿ç”¨Reflect.ownKeysä»¥æ”¯æŒSymbolç±»å‹çš„é”®
  Reflect.ownKeys(source).forEach(key => {
    cloneObj[key] = deepClone(source[key], memory);
  });

  return cloneObj;
}
```

# ğŸ¯ äºŒã€EventEmitter æ¨¡å—

EventEmitter æ˜¯ Node.js äº‹ä»¶é©±åŠ¨æ¶æ„çš„æ ¸å¿ƒï¼Œå®ƒå®ç°äº†å‘å¸ƒ-è®¢é˜…æ¨¡å¼ï¼Œå…è®¸å¯¹è±¡ç»‘å®šã€è§¦å‘å’Œç§»é™¤äº‹ä»¶ç›‘å¬å™¨ã€‚

## 1. æ ¸å¿ƒäº‹ä»¶æ–¹æ³•

* `on(eventName, listener)`ï¼šç»‘å®šä¸€ä¸ªäº‹ä»¶ç›‘å¬å™¨åˆ°æŒ‡å®šäº‹ä»¶åã€‚å¯ä»¥ä¸ºä¸€ä¸ªäº‹ä»¶åç»‘å®šå¤šä¸ªç›‘å¬å™¨ã€‚
* `emit(eventName, ...args)`ï¼šè§¦å‘æŒ‡å®šäº‹ä»¶åï¼Œå¹¶æŒ‰æ³¨å†Œé¡ºåºåŒæ­¥è°ƒç”¨æ‰€æœ‰ç›‘å¬å™¨ï¼Œä¼ å…¥æä¾›çš„å‚æ•°ã€‚
* `off(eventName, listener)`æˆ– `removeListener(eventName, listener)`ï¼šä»æŒ‡å®šäº‹ä»¶ä¸Šç§»é™¤ä¸€ä¸ªå…·ä½“çš„ç›‘å¬å™¨ã€‚

## 2. ä¸€æ¬¡æ€§äº‹ä»¶

* `once(eventName, listener)`ï¼šç»‘å®šä¸€ä¸ªåªèƒ½è¢«è§¦å‘ä¸€æ¬¡çš„ç›‘å¬å™¨ã€‚åœ¨ç¬¬ä¸€æ¬¡è§¦å‘åï¼Œç›‘å¬å™¨ä¼šè¢«è‡ªåŠ¨ç§»é™¤ã€‚è¿™é€šå¸¸é€šè¿‡åœ¨ç›‘å¬å™¨å¤–åŒ…è£¹ä¸€å±‚å‡½æ•°æ¥å®ç°ï¼Œåœ¨å‡½æ•°å†…éƒ¨è°ƒç”¨ `off`æˆ– `removeListener`æ–¹æ³•ç§»é™¤è‡ªèº«ã€‚

## 3. ç›‘å¬å™¨ç®¡ç†

* `listeners(eventName)`ï¼šè¿”å›æŒ‡å®šäº‹ä»¶çš„æ‰€æœ‰ç›‘å¬å™¨å‡½æ•°çš„æ•°ç»„å‰¯æœ¬ã€‚
* `removeAllListeners([eventName])`ï¼šç§»é™¤æŒ‡å®šäº‹ä»¶çš„æ‰€æœ‰ç›‘å¬å™¨ã€‚å¦‚æœä¸ä¼ å…¥äº‹ä»¶åï¼Œåˆ™ç§»é™¤æ‰€æœ‰äº‹ä»¶çš„æ‰€æœ‰ç›‘å¬å™¨ï¼ˆæ…ç”¨ï¼‰ã€‚

## 4. é«˜çº§åŠŸèƒ½ä¸é˜²æŠ¤

* **æœ€å¤§ç›‘å¬æ•°é™åˆ¶**ï¼šè®¾ç½®ä¸€ä¸ªé»˜è®¤çš„ `maxListeners`é˜ˆå€¼ï¼ˆä¾‹å¦‚ 10ï¼‰ï¼Œå¹¶ä¸ºè¶…è¿‡é™åˆ¶çš„äº‹ä»¶æ·»åŠ ç›‘å¬å™¨æ—¶è§¦å‘ `è­¦å‘Š`ï¼Œé˜²æ­¢å†…å­˜æ³„æ¼ã€‚å¯ä»¥é€šè¿‡ `getMaxListeners()`å’Œ `setMaxListeners(n)`æ¥è·å–å’Œè®¾ç½®è¿™ä¸ªå€¼ã€‚
* **é”™è¯¯äº‹ä»¶ç‰¹æ®Šå¤„ç†**ï¼šå¯¹ `'error'`äº‹ä»¶è¿›è¡Œç‰¹æ®Šå¤„ç†ã€‚å¦‚æœè§¦å‘äº† `'error'`äº‹ä»¶ä½†æ²¡æœ‰ä¸ºå…¶ç»‘å®šä»»ä½•ç›‘å¬å™¨ï¼Œåˆ™åº”å°†é”™è¯¯æŠ›å‡ºå¹¶å¯¼è‡´è¿›ç¨‹å´©æºƒï¼Œè¿™æ˜¯ Node.js åŸç”Ÿ EventEmitter çš„é»˜è®¤è¡Œä¸ºï¼Œæœ‰åŠ©äºå¿«é€Ÿå‘ç°æœªå¤„ç†çš„é”™è¯¯ã€‚
* **åœ¨ç›‘å¬å™¨ä¸­è§¦å‘äº‹ä»¶**ï¼šéœ€è¦æ³¨æ„åœ¨æŸä¸ªäº‹ä»¶çš„ç›‘å¬å™¨å‡½æ•°å†…éƒ¨åˆè§¦å‘äº†ç›¸åŒäº‹ä»¶ï¼Œè¿™å¯èƒ½å¯¼è‡´é€’å½’å¾ªç¯å’Œæ ˆæº¢å‡ºï¼Œå®ç°æ—¶åº”è€ƒè™‘æ˜¯å¦éœ€è¦è¿›è¡Œé˜²æŠ¤æˆ–æ£€æµ‹ã€‚

## 5. å®ç°ä»£ç ç¤ºä¾‹

```
class EventEmitter {
  constructor() {
    this.events = {}; // å­˜å‚¨äº‹ä»¶åä¸ç›‘å¬å™¨æ•°ç»„çš„æ˜ å°„
    this._maxListeners = 10; // é»˜è®¤æœ€å¤§ç›‘å¬æ•°
  }

  on(eventName, listener) {
    if (!this.events[eventName]) {
      this.events[eventName] = [];
    }
    this.events[eventName].push(listener);

    // æœ€å¤§ç›‘å¬æ•°æ£€æŸ¥
    if (this._maxListeners > 0 && this.events[eventName].length > this._maxListeners) {
      console.warn(`Possible EventEmitter memory leak detected. ${this.events[eventName].length} ${eventName} listeners added. Use emitter.setMaxListeners() to increase limit`);
    }
    return this; // æ”¯æŒé“¾å¼è°ƒç”¨
  }

  emit(eventName, ...args) {
    const listeners = this.events[eventName];
    if (!listeners || listeners.length === 0) {
      // å¦‚æœæ²¡æœ‰ç›‘å¬å™¨ï¼Œç‰¹åˆ«æ˜¯å¯¹äº'error'äº‹ä»¶ï¼ŒæŠ›å‡ºé”™è¯¯
      if (eventName === 'error') {
        throw new Error('Unhandled error.');
      }
      return false;
    }

    // éå†è°ƒç”¨æ‰€æœ‰ç›‘å¬å™¨ï¼Œæ³¨æ„ä½¿ç”¨åˆ‡ç‰‡å¤åˆ¶æ•°ç»„ï¼Œé˜²æ­¢åœ¨å›è°ƒä¸­æ“ä½œåŸæ•°ç»„å½±å“æœ¬æ¬¡è§¦å‘
    listeners.slice().forEach(listener => {
      listener.apply(this, args);
    });
    return true;
  }

  off(eventName, listenerToRemove) {
    if (!this.events[eventName]) return this;

    this.events[eventName] = this.events[eventName].filter(listener => listener !== listenerToRemove);
    return this;
  }

  once(eventName, listener) {
    const onceWrapper = (...args) => {
      listener.apply(this, args);
      this.off(eventName, onceWrapper); // æ‰§è¡Œä¸€æ¬¡åè‡ªè¡Œç§»é™¤
    };
    return this.on(eventName, onceWrapper);
  }

  listeners(eventName) {
    return this.events[eventName] ? this.events[eventName].slice() : [];
  }

  removeAllListeners(eventName) {
    if (eventName) {
      delete this.events[eventName];
    } else {
      this.events = {};
    }
    return this;
  }

  setMaxListeners(n) {
    this._maxListeners = n;
    return this;
  }

  getMaxListeners() {
    return this._maxListeners;
  }
}
```

# ğŸ’ æ€»ç»“ä¸å»ºè®®

è¦å®ç°è¿™ä¸¤ä¸ªæ¨¡å—ï¼Œå¯ä»¥éµå¾ªä»¥ä¸‹æ­¥éª¤å’Œæ€è·¯ï¼š

1. **æ·±æ‹·è´æ¨¡å—**ï¼šæ ¸å¿ƒæ˜¯**é€’å½’**å’Œ**å¤„ç†å¾ªç¯å¼•ç”¨**ã€‚å…ˆä»åŸºç¡€æ•°æ®ç±»å‹å’Œç®€å•å¯¹è±¡å¼€å§‹ï¼Œé€æ­¥æ·»åŠ å¯¹æ•°ç»„ã€Dateã€RegExpã€Mapã€Setç­‰ç‰¹æ®Šç±»å‹çš„æ”¯æŒã€‚åŠ¡å¿…ä½¿ç”¨ `WeakMap`æ¥è§£å†³å¾ªç¯å¼•ç”¨é—®é¢˜ã€‚
2. **EventEmitter æ¨¡å—**ï¼šæ ¸å¿ƒæ˜¯ç»´æŠ¤ä¸€ä¸ª**äº‹ä»¶å-ç›‘å¬å™¨æ•°ç»„**çš„æ˜ å°„å¯¹è±¡ (`events: {}`)ã€‚é‡ç‚¹å®ç° `on`, `emit`, `off`/`removeListener`æ–¹æ³•ï¼Œç„¶ååœ¨æ­¤åŸºç¡€ä¸Šæ‰©å±• `once`ã€`removeAllListeners`ç­‰åŠŸèƒ½ã€‚ç‰¹åˆ«è¦æ³¨æ„å¯¹ `'error'`äº‹ä»¶çš„å¤„ç†å’Œæœ€å¤§ç›‘å¬æ•°çš„è­¦å‘Šã€‚
3. **æµ‹è¯•é©±åŠ¨å¼€å‘ (TDD)**ï¼šä¸ºæ¯ä¸ªåŠŸèƒ½ç‚¹ç¼–å†™è¯¦å°½çš„å•å…ƒæµ‹è¯•æ˜¯ä¿è¯æ¨¡å—ç¨³å®šæ€§çš„å…³é”®ã€‚å°¤å…¶è¦æµ‹è¯•æ·±æ‹·è´ä¸­çš„å¾ªç¯å¼•ç”¨ã€ç‰¹æ®Šç±»å‹ï¼Œä»¥åŠ EventEmitter ä¸­çš„å¤šæ¬¡è§¦å‘ã€é”™è¯¯å¤„ç†ã€ç›‘å¬å™¨æ•°é‡ç­‰è¾¹ç•Œæƒ…å†µã€‚
4. **å‚è€ƒåŸç”Ÿå®ç°**ï¼šè™½ç„¶ä½ è‡ªå·±å®ç°æ˜¯å¾ˆå¥½çš„å­¦ä¹ è¿‡ç¨‹ï¼Œä½†åœ¨ç”Ÿäº§ç¯å¢ƒä¸­ï¼Œå»ºè®®ä¼˜å…ˆä½¿ç”¨ Node.js å†…ç½®çš„ `events`æ¨¡å—å’Œç¤¾åŒºå¹¿æ³›æµ‹è¯•è¿‡çš„åº“ï¼ˆå¦‚ Lodash çš„ `_.cloneDeep`ï¼‰ã€‚ä½ çš„å®ç°å¯ä»¥åŠ›æ±‚ç†è§£åŸç†ï¼Œå¹¶ä¸åŸç”Ÿæ¨¡å—çš„APIä¿æŒå…¼å®¹ï¼Œè¿™æ ·å¯ä»¥æ–¹ä¾¿åœ°æ›¿æ¢å’Œæµ‹è¯•ã€‚

å¸Œæœ›è¿™ä»½è¯¦ç»†çš„æ‹†è§£èƒ½å¸®åŠ©ä½ æ›´å¥½åœ°è®¾è®¡å’Œå®ç°è¿™ä¸¤ä¸ªé‡è¦çš„ Node.js æ¨¡å—ï¼
