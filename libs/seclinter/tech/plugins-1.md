ä¸ºä½ çš„ SecLinter å®‰å…¨å·¥å…·åŒ…è®¾è®¡ä¸€ä¸ªæ’ä»¶ç³»ç»Ÿï¼Œæ˜¯è®©å…¶ä¿æŒæ´»åŠ›å’Œå¼ºå¤§çš„å…³é”®ã€‚ä¸‹é¢æˆ‘å°†ä¸ºä½ æä¾›ä¸€ä¸ªç»“åˆäº†ç°ä»£æ’ä»¶æ¶æ„æœ€ä½³å®è·µçš„è®¾è®¡æ–¹æ¡ˆï¼Œå®ƒå¼ºè°ƒ**å®‰å…¨æ€§**ã€**æ‰©å±•æ€§**å’Œ**å¼€å‘è€…å‹å¥½æ€§**ã€‚

### ğŸ§© ä¸€ã€æ ¸å¿ƒè®¾è®¡åŸåˆ™

1.  **è§£è€¦ä¸æ‰©å±•æ€§**ï¼šæ ¸å¿ƒç³»ç»Ÿåªè´Ÿè´£æ’ä»¶ç®¡ç†ã€ç”Ÿå‘½å‘¨æœŸè°ƒåº¦å’Œæä¾›åŸºç¡€æœåŠ¡ã€‚æ‰€æœ‰å…·ä½“çš„å®‰å…¨æ£€æµ‹è§„åˆ™éƒ½åº”ä½œä¸ºç‹¬ç«‹æ’ä»¶å­˜åœ¨ï¼Œå…è®¸ç¤¾åŒºå¼€å‘è€…åœ¨ä¸ä¿®æ”¹æ ¸å¿ƒä»£ç çš„æƒ…å†µä¸‹æ‰©å±•åŠŸèƒ½ã€‚
2.  **å®‰å…¨ç¬¬ä¸€**ï¼šæ’ä»¶ç³»ç»Ÿå¿…é¡»**éš”ç¦»**å’Œ**å®¹é”™**ã€‚ä¸€ä¸ªæ’ä»¶çš„å´©æºƒæˆ–å®‰å…¨æ¼æ´ä¸åº”å½±å“æ ¸å¿ƒå·¥å…·æˆ–å…¶ä»–æ’ä»¶çš„è¿è¡Œã€‚è¿™å¯¹äºå®‰å…¨å·¥å…·æ¥è¯´è‡³å…³é‡è¦ã€‚
3.  **çº¦å®šä¼˜äºé…ç½®**ï¼šæä¾›æ¸…æ™°çš„æ¥å£è§„èŒƒã€ç®€å•çš„å¼€å‘æ¨¡æ¿å’Œè‡ªåŠ¨åŒ–å·¥å…·ï¼Œé™ä½ç¤¾åŒºè´¡çŒ®è€…çš„å¼€å‘é—¨æ§›ã€‚
4.  **æ€§èƒ½ä¸å¯æ§æ€§**ï¼šæ”¯æŒæ’ä»¶çš„æŒ‰éœ€åŠ è½½å’Œå¸è½½ï¼Œé¿å…ä¸å¿…è¦çš„æ€§èƒ½å¼€é”€ã€‚åŒæ—¶ï¼Œæ ¸å¿ƒç³»ç»Ÿåº”èƒ½ç›‘æ§æ’ä»¶çš„èµ„æºä½¿ç”¨æƒ…å†µï¼ˆå¦‚å†…å­˜ã€CPUï¼‰ã€‚

### ğŸ—ï¸ äºŒã€æ’ä»¶ç³»ç»Ÿæ¶æ„è®¾è®¡

æ•´ä¸ªç³»ç»Ÿå¯ä»¥é‡‡ç”¨ **â€œå†…æ ¸ (Core) + æ’ä»¶ (Plugin)â€** çš„æ¶æ„ï¼Œå¹¶å¼•å…¥ **æ²™ç®± (Sandbox)** æœºåˆ¶æ¥éš”ç¦»æ’ä»¶è¿è¡Œç¯å¢ƒã€‚

| **ç³»ç»Ÿå±‚** | **èŒè´£** | **å…³é”®æŠ€æœ¯/å®ç°** |
| :--- | :--- | :--- |
| **å†…æ ¸ (Core)** | æ’ä»¶æ³¨å†Œã€ç”Ÿå‘½å‘¨æœŸç®¡ç†ã€æä¾›å…¬å…±æœåŠ¡ï¼ˆå¦‚æ—¥å¿—ã€é…ç½®ã€äº‹ä»¶æ€»çº¿ï¼‰ã€å®‰å…¨æ²™ç®±ç®¡ç† | TypeScript æ¥å£ã€ä¾èµ–æ³¨å…¥ |
| **æ’ä»¶ (Plugin)** | å®ç°å…·ä½“çš„å®‰å…¨æ£€æµ‹è§„åˆ™ï¼ˆå¦‚æ£€æµ‹æ–°çš„ XSS å‘é‡ã€ç‰¹å®šçš„æ•æ„Ÿä¿¡æ¯æ¨¡å¼ï¼‰ | å®ç°æ ‡å‡†æ¥å£ã€ç‹¬ç«‹æ‰“åŒ… |
| **æ²™ç®± (Sandbox)** | ä¸ºæ’ä»¶æä¾›éš”ç¦»çš„æ‰§è¡Œç¯å¢ƒï¼Œé™åˆ¶å…¶è®¿é—®æƒé™ï¼Œç¡®ä¿æ ¸å¿ƒç³»ç»Ÿå®‰å…¨ | Node.js `vm` æ¨¡å—ã€Proxy ä»£ç† |

ä¸‹é¢æ˜¯è¯¥æ’ä»¶ç³»ç»Ÿçš„è¿è¡Œæµç¨‹ï¼š
```mermaid
flowchart TD
A[ç¤¾åŒºå¼€å‘è€…ç¼–å†™æ’ä»¶] --> B[å®ç° PluginInterface<br>å®šä¹‰çš„æ ‡å‡†æ¥å£]
B --> C[æ‰“åŒ…ä¸º npm åŒ…<br>åç§°éµå¾ª seclinter-plugin-* è§„èŒƒ]
C --> D[ç”¨æˆ·é€šè¿‡ npm å®‰è£…æ’ä»¶]
D --> E[SecLinter å†…æ ¸è‡ªåŠ¨è¯†åˆ«<br>æˆ–é€šè¿‡é…ç½®æ³¨å†Œæ’ä»¶]
E --> F[å†…æ ¸å°†æ’ä»¶è½½å…¥<br>Sandbox æ²™ç®±ç¯å¢ƒ]
F --> G[æ’ä»¶åœ¨æ²™ç®±å†…è¿è¡Œ<br>é€šè¿‡äº‹ä»¶æ€»çº¿ä¸å†…æ ¸é€šä¿¡]
G --> H[æ‰«æç»“æœç»å†…æ ¸èšåˆå<br>ç»Ÿä¸€è¾“å‡ºç»™ç”¨æˆ·]
```

### ğŸ“ ä¸‰ã€æ ¸å¿ƒæ¥å£ä¸ç±»å‹å®šä¹‰

é¦–å…ˆï¼Œåœ¨ `seclinter` æ ¸å¿ƒåŒ…ä¸­å®šä¹‰ä¸€å¥—æ‰€æœ‰æ’ä»¶å¿…é¡»éµå¾ªçš„ TypeScript æ¥å£ã€‚

```typescript
// src/core/pluginInterface.ts

/**
 * æ’ä»¶å…ƒæ•°æ®
 */
export interface PluginMeta {
  name: string;
  version: string;
  author?: string;
  description: string;
  // è¯¥æ’ä»¶é’ˆå¯¹çš„æ‰«æç±»å‹ï¼Œå¦‚ 'dependency', 'secret', 'header' ç­‰
  target: string;
}

/**
 * æ’ä»¶å¿…é¡»å®ç°çš„æ ¸å¿ƒæ–¹æ³•
 */
export interface PluginInterface {
  /**
   * åˆå§‹åŒ–æ’ä»¶ï¼Œå†…æ ¸ä¼šæ³¨å…¥å®‰å…¨æ²™ç®±å’Œå·¥å…·å‡½æ•°
   */
  init(sandbox: Sandbox, helpers?: PluginHelpers): Promise<void>;

  /**
   * æ‰§è¡Œæ‰«æçš„ä¸»è¦é€»è¾‘ï¼Œè¿”å›æ‰«æç»“æœ
   */
  scan(projectPath: string): Promise<ScanResult[]>;

  /**
   * ï¼ˆå¯é€‰ï¼‰æ¸…ç†èµ„æº
   */
  cleanup?(): Promise<void>;
}

/**
 * å†…æ ¸æä¾›ç»™æ’ä»¶çš„å·¥å…·å‡½æ•°
 */
export interface PluginHelpers {
  logger: {
    info: (msg: string) => void;
    warn: (msg: string) => void;
    error: (msg: string) => void;
  };
// å¯ç”¨äºç½‘ç»œè¯·æ±‚çš„å®‰å…¨å®¢æˆ·ç«¯ï¼ˆè‡ªå¸¦é€Ÿç‡é™åˆ¶ã€é”™è¯¯å¤„ç†ï¼‰
httpClient: SecureHttpClient;
// å…¶ä»–å·¥å…·...
}

/**
 * ç»Ÿä¸€çš„æ‰«æç»“æœæ ¼å¼
 */
export interface ScanResult {
  ruleId: string; // è§„åˆ™å”¯ä¸€æ ‡è¯†ï¼Œå¦‚ 'no-hardcoded-keys'
  plugin: string; // æ’ä»¶å
  level: 'info' | 'low' | 'medium' | 'high' | 'critical';
  file?: string; // é—®é¢˜æ‰€åœ¨æ–‡ä»¶
  line?: number; // é—®é¢˜è¡Œå·
  message: string; // æè¿°ä¿¡æ¯
  suggestion?: string; // ä¿®å¤å»ºè®®
}
```

### ğŸ“¦ å››ã€æ’ä»¶å¼€å‘èŒƒå¼ä¸æ²™ç®±éš”ç¦»

ç¤¾åŒºå¼€å‘è€…å¯ä»¥æŒ‰ç…§ä»¥ä¸‹èŒƒå¼åˆ›å»ºä¸€ä¸ªæ–°çš„å®‰å…¨æ’ä»¶ï¼š

1.  **åˆ›å»ºæ–°é¡¹ç›®**ï¼š
```bash
mkdir seclinter-plugin-super-xss
cd seclinter-plugin-super-xss
npm init -y
```
2.  **å®ç°æ¥å£**ï¼š
```typescript
// src/index.ts
import { PluginInterface, ScanResult, PluginMeta } from 'seclinter';

const meta: PluginMeta = {
  name: 'seclinter-plugin-super-xss',
  version: '1.0.0',
  description: 'A plugin to detect advanced XSS vectors',
  target: 'xss',
};

class SuperXSSPlugin implements PluginInterface {
  async init(sandbox: Sandbox, helpers: PluginHelpers) {
    // åœ¨æ²™ç®±ä¸­åˆå§‹åŒ–ï¼Œå¯ä»¥å®‰å…¨åœ°è®¿é—®å—é™çš„å…¨å±€å¯¹è±¡
    this.helpers = helpers;
    this.helpers.logger.info('SuperXSSPlugin initialized');
  }

  async scan(projectPath: string): Promise<ScanResult[]> {
    // å®ç°æ‰«æé€»è¾‘...
    const results: ScanResult[] = [];
    // ... æ£€æŸ¥ä»£ç  ...
    if (foundVulnerability) {
      results.push({
        ruleId: 'super-xss-rule-1',
        plugin: meta.name,
        level: 'high',
        file: 'src/app.js',
        line: 123,
        message: 'Found potential advanced XSS vector',
        suggestion: 'Use output encoding library X',
      });
    }
    return results;
  }
}

export default SuperXSSPlugin;
export { meta };
```
3.  **å†…æ ¸ä½¿ç”¨æ²™ç®±åŠ è½½æ’ä»¶**ï¼š
å†…æ ¸ä¸åº”ç›´æ¥ `require` æ’ä»¶ï¼Œè€Œåº”é€šè¿‡æ²™ç®±æ¥æ‰§è¡Œæ’ä»¶ä»£ç ã€‚
```typescript
// src/core/sandbox.ts
import { NodeVM, VMScript } from 'vm2'; // ä¸€ä¸ªæµè¡Œçš„ç”¨äºåˆ›å»ºæ²™ç®±çš„åº“

export class Sandbox {
  private vm: NodeVM;

  constructor() {
    this.vm = new NodeVM({
      // ä¸¥æ ¼é™åˆ¶å¯è®¿é—®çš„æ¨¡å—
      require: {
        external: true, // å…è®¸å¼•å…¥å¤–éƒ¨åŒ…
        builtin: ['path', 'fs'], // åªå…è®¸ç™½åå•å†…çš„å†…ç½®æ¨¡å—
        root: './', // é™åˆ¶èŒƒå›´
      },
      sandbox: {}, // å¯æ³¨å…¥ä¸€äº›å®‰å…¨çš„å…¨å±€å˜é‡
      wrapper: 'commonjs',
    });
  }

  async runPlugin(pluginPath: string): Promise<PluginInterface> {
    try {
      // åœ¨æ²™ç®±ä¸­è¿è¡Œæ’ä»¶ä»£ç 
      const pluginCode = await fs.promises.readFile(pluginPath, 'utf-8');
      const pluginInstance = this.vm.run(pluginCode)();
      return pluginInstance;
    } catch (error) {
      throw new Error(`Failed to run plugin in sandbox: ${error.message}`);
    }
  }
}
```

### ğŸ”§ äº”ã€æ’ä»¶æ³¨å†Œä¸å‘ç°æœºåˆ¶

ä¸ºäº†è®©å†…æ ¸èƒ½å‘ç°å¹¶åŠ è½½ç¤¾åŒºæ’ä»¶ï¼Œå¯ä»¥é‡‡ç”¨ä»¥ä¸‹æ–¹å¼ï¼š

1.  **çº¦å®šå‘½å**ï¼šç¤¾åŒºæ’ä»¶åº”éµå¾ªå‘½åçº¦å®š `seclinter-plugin-*`ã€‚
2.  **è‡ªåŠ¨å‘ç°**ï¼šå†…æ ¸å¯ä»¥é€šè¿‡æ‰«æ `node_modules` ä¸­ç¬¦åˆå‘½åè§„åˆ™çš„åŒ…æ¥å‘ç°æ’ä»¶ã€‚
```typescript
// src/core/pluginManager.ts
import { readdirSync } from 'fs';

export class PluginManager {
  async autoDiscoverPlugins(): Promise<void> {
    // ç®€åŒ–ç¤ºä¾‹ï¼šéå† node_modules å¯»æ‰¾ç¬¦åˆå‰ç¼€çš„åŒ…
    const modulesDir = 'node_modules';
    const dirs = readdirSync(modulesDir);
    const pluginPackages = dirs.filter(dir => dir.startsWith('seclinter-plugin-'));

    for (const pkgName of pluginPackages) {
      try {
        const pluginPath = require.resolve(pkgName);
        this.registerPlugin(pluginPath);
      } catch (error) {
        this.logger.warn(`Failed to load plugin ${pkgName}: ${error.message}`);
      }
    }
  }

  async registerPlugin(pluginPath: string): Promise<void> {
    // 1. é€šè¿‡æ²™ç®±åŠ è½½æ’ä»¶
    const pluginInstance = await this.sandbox.runPlugin(pluginPath);
    // 2. è°ƒç”¨æ’ä»¶çš„ init æ–¹æ³•
    await pluginInstance.init(this.sandbox, this.helpers);
    // 3. å­˜å‚¨æ’ä»¶å®ä¾‹ï¼Œå¹¶æŒ‰ target åˆ†ç±»
    this.plugins.set(pluginInstance.meta.name, pluginInstance);
  }
}
```
3.  **é…ç½®æ˜¾å¼å¯ç”¨**ï¼šåœ¨ `seclinter.config.ts` ä¸­ï¼Œå…è®¸ç”¨æˆ·æ˜¾å¼å¯ç”¨æˆ–ç¦ç”¨ç‰¹å®šæ’ä»¶ï¼Œæä¾›çµæ´»æ€§ã€‚
```typescript
// seclinter.config.ts æˆ– .seclinterrc
export default {
  plugins: {
    // å¯ç”¨è‡ªåŠ¨å‘ç°çš„æ’ä»¶
    'seclinter-plugin-super-xss': true,
    // æ˜ç¡®æŒ‡å®šæœ¬åœ°æ’ä»¶è·¯å¾„
    './local-plugins/my-custom-rule.js': true,
    // ç¦ç”¨æŸä¸ªæ’ä»¶
    'seclinter-plugin-some-rule': false,
  },
};
```

### ğŸ›¡ï¸ å…­ã€é”™è¯¯å¤„ç†ä¸ç†”æ–­æœºåˆ¶

å€Ÿé‰´ ByteTop çš„è®¾è®¡ï¼Œå¿…é¡»ç¡®ä¿æ’ä»¶çš„é”™è¯¯ä¸ä¼šå½±å“æ ¸å¿ƒç³»ç»Ÿã€‚

1.  **Try-Catch åŒ…è£…**ï¼šæ‰€æœ‰æ’ä»¶çš„ `init`ã€`scan` æ–¹æ³•è°ƒç”¨éƒ½åº”ç”¨ `try-catch` åŒ…è£…ã€‚
2.  **ç†”æ–­æœºåˆ¶**ï¼šå¦‚æœä¸€ä¸ªæ’ä»¶è¿ç»­å¤šæ¬¡å¤±è´¥ï¼Œåº”å°†å…¶è‡ªåŠ¨ç¦ç”¨å¹¶æ ‡è®°ä¸ºä¸å¥åº·ï¼Œé˜²æ­¢æŒç»­æŠ¥é”™å½±å“æ‰«æä½“éªŒã€‚
```typescript
async runScan(projectPath: string) {
  for (const [name, plugin] of this.plugins) {
    try {
      const results = await plugin.scan(projectPath);
      this.handleResults(results);
      // æˆåŠŸåˆ™é‡ç½®é”™è¯¯è®¡æ•°
      this.pluginStatus.get(name).errorCount = 0;
    } catch (error) {
      this.logger.error(`Plugin ${name} failed: ${error.message}`);
      const status = this.pluginStatus.get(name);
      status.errorCount++;

      // å¦‚æœé”™è¯¯è¶…è¿‡é˜ˆå€¼ï¼Œç†”æ–­ï¼Œç¦ç”¨è¯¥æ’ä»¶
      if (status.errorCount > 3) {
        status.healthy = false;
        this.logger.warn(`Plugin ${name} is disabled due to repeated failures.`);
      }
    }
  }
}
```

### ğŸ“¢ ä¸ƒã€ç¤¾åŒºæ”¯æŒä¸æ–‡æ¡£

ä¸ºäº†è®©ç¤¾åŒºæ›´å®¹æ˜“è´¡çŒ®ï¼Œä½ éœ€è¦æä¾›ï¼š

1.  **è¯¦ç»†çš„å¼€å‘è€…æ–‡æ¡£**ï¼šåŒ…æ‹¬æ¥å£å®šä¹‰ã€ç¤ºä¾‹ä»£ç ã€æ²™ç®±ç¯å¢ƒè¯´æ˜ã€è°ƒè¯•æ–¹æ³•ç­‰ã€‚
2.  **æ’ä»¶æ¨¡æ¿ç”Ÿæˆå™¨**ï¼šåˆ›å»ºä¸€ä¸ª `create-seclinter-plugin` è„šæ‰‹æ¶å·¥å…·ï¼Œå¿«é€Ÿç”Ÿæˆæ’ä»¶é¡¹ç›®ç»“æ„ã€‚
```bash
npx create-seclinter-plugin --target=secret --name=my-rule
```
3.  **æµ‹è¯•ä¸éªŒè¯æŒ‡å—**ï¼šè¯´æ˜å¦‚ä½•ä¸ºæ’ä»¶ç¼–å†™ Vitest æµ‹è¯•ç”¨ä¾‹ï¼Œå¹¶é›†æˆåˆ° SecLinter çš„æµ‹è¯•æµç¨‹ä¸­ã€‚
4.  **å®¡æ ¸ä¸å®‰å…¨æŒ‡å—**ï¼šå»ºç«‹ä¸€å¥—æ’ä»¶å®¡æ ¸æµç¨‹ï¼Œç‰¹åˆ«æ˜¯å¯¹äºè¦æ±‚è¾ƒé«˜æƒé™çš„æ’ä»¶ï¼Œç¡®ä¿å…¶ä»£ç è´¨é‡å’Œå®‰å…¨æ€§ã€‚

### ğŸ’ æ€»ç»“

ä¸º SecLinter è®¾è®¡ä¸€ä¸ªæˆåŠŸçš„æ’ä»¶ç³»ç»Ÿï¼Œå…³é”®åœ¨äºåœ¨**çµæ´»æ€§**å’Œ**å®‰å…¨æ€§**ä¹‹é—´æ‰¾åˆ°å¹³è¡¡ã€‚é€šè¿‡ **æ¸…æ™°çš„æ¥å£çº¦å®š**ã€**å®‰å…¨çš„æ²™ç®±éš”ç¦»**ã€**æœ‰æ•ˆçš„é”™è¯¯å¤„ç†** å’Œ **ä¾¿æ·çš„å¼€å‘è€…å·¥å…·**ï¼Œä½ èƒ½æ„å»ºä¸€ä¸ªå¼ºå¤§çš„ç”Ÿæ€ç³»ç»Ÿï¼Œè®©ç¤¾åŒºæºæºä¸æ–­åœ°ä¸ºå…¶æ³¨å…¥æ–°çš„å®‰å…¨æ£€æµ‹èƒ½åŠ›ï¼ŒåŒæ—¶ç¡®ä¿å·¥å…·æœ¬èº«çš„æ ¸å¿ƒç¨³å®šæ€§å’Œç”¨æˆ·å®‰å…¨ã€‚

å¸Œæœ›è¿™ä¸ªè®¾è®¡æ–¹æ¡ˆèƒ½ä¸ºä½ æä¾›æ¸…æ™°çš„å®ç°è·¯å¾„ã€‚å¦‚æœä½ åœ¨å…·ä½“å®ç°æŸä¸ªç¯èŠ‚æ—¶é‡åˆ°é—®é¢˜ï¼Œæˆ‘ä»¬å¯ä»¥ç»§ç»­æ·±å…¥è®¨è®ºã€‚